// deployment/Jenkinsfile_ArgoCD

def PIPELINE_ID = "${env.BUILD_NUMBER}"

def getImageTag() {
    def dateFormat = new java.text.SimpleDateFormat('yyyyMMddHHmmss')
    def currentDate = new Date()
    return dateFormat.format(currentDate)
}

podTemplate(
    label: "${PIPELINE_ID}",
    serviceAccount: 'jenkins',
    containers: [
        containerTemplate(name: 'node', image: 'node:20-slim', ttyEnabled: true, command: 'cat'),
        containerTemplate(name: 'podman', image: "mgoltzsche/podman", ttyEnabled: true, command: 'cat', privileged: true),
        containerTemplate(name: 'git', image: 'alpine/git:latest', command: 'cat', ttyEnabled: true)
    ],
    volumes: [
        emptyDirVolume(mountPath: '/run/podman', memory: false)
    ]
) {
    node(PIPELINE_ID) {
        def props
        def imageTag = getImageTag()
        
        // Manifest Repository ì„¤ì •
        def MANIFEST_REPO = 'https://github.com/won-ktds/smarketing-manifest.git'
        def MANIFEST_CREDENTIAL_ID = 'github-credentials-smarketing'

        try {
            stage("Get Source") {
                checkout scm
                
                // í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸ ë° ì½ê¸°
                if (!fileExists('deployment/deploy_env_vars')) {
                    error "deployment/deploy_env_vars íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
                }
                
                props = readProperties file: "deployment/deploy_env_vars"
                
                // í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦
                if (!props.registry || !props.image_org || !props.namespace) {
                    error "í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. registry, image_org, namespaceë¥¼ í™•ì¸í•˜ì„¸ìš”."
                }
                
                echo "=== Build Information ==="
                echo "Service: smarketing-frontend"
                echo "Image Tag: ${imageTag}"
                echo "Registry: ${props.registry}"
                echo "Image Org: ${props.image_org}"
                echo "Namespace: ${props.namespace}"
            }

            stage("Check Changes") {
                script {
                    def changes = sh(
                        script: "git diff --name-only HEAD~1 HEAD",
                        returnStdout: true
                    ).trim()

                    if (!changes.contains("src/") && !changes.contains("public/") && !changes.contains("package")) {
                        echo "No significant frontend changes detected, skipping build"
                        currentBuild.result = 'SUCCESS'
                        error("Stopping pipeline - no frontend changes detected")
                    }

                    echo "Frontend changes detected, proceeding with build"
                }
            }

            stage('Build & Push Frontend Image') {
                container('podman') {
                    sh 'podman system service -t 0 unix:///run/podman/podman.sock & sleep 2'
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'acr-credentials',
                        usernameVariable: 'ACR_USERNAME',
                        passwordVariable: 'ACR_PASSWORD'
                    )]) {
                        def imagePath = "${props.registry}/${props.image_org}/smarketing-frontend:${imageTag}"
                        
                        sh """
                            echo "=========================================="
                            echo "Building smarketing-frontend"
                            echo "Image Tag: ${imageTag}"
                            echo "Image Path: ${imagePath}"
                            echo "=========================================="

                            # ACR ë¡œê·¸ì¸
                            echo \$ACR_PASSWORD | podman login ${props.registry} --username \$ACR_USERNAME --password-stdin

                            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
                            podman build \\
                                --build-arg PROJECT_FOLDER="." \\
                                --build-arg VUE_APP_AUTH_URL="${props.auth_url}" \\
                                --build-arg VUE_APP_MEMBER_URL="${props.member_url}" \\
                                --build-arg VUE_APP_STORE_URL="${props.store_url}" \\
                                --build-arg VUE_APP_MENU_URL="${props.menu_url}" \\
                                --build-arg VUE_APP_SALES_URL="${props.sales_url}" \\
                                --build-arg VUE_APP_CONTENT_URL="${props.content_url}" \\
                                --build-arg VUE_APP_RECOMMEND_URL="${props.recommend_url}" \\
                                --build-arg BUILD_FOLDER="deployment/container" \\
                                --build-arg EXPORT_PORT="${props.export_port}" \\
                                -f deployment/container/Dockerfile-smarketing-frontend \\
                                -t ${imagePath} .

                            # ì´ë¯¸ì§€ í‘¸ì‹œ
                            podman push ${imagePath}
                            
                            echo "âœ… Frontend image pushed successfully: ${imagePath}"
                        """
                    }
                }
            }

            stage('Update Manifest Repository') {
                container('git') {
                    script {
                        // Manifest Repository Clone
                        withCredentials([usernamePassword(
                            credentialsId: MANIFEST_CREDENTIAL_ID,
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GIT_PASSWORD'
                        )]) {
                            sh """
                                echo "=== Git ì„¤ì • ==="
                                git config --global user.name "Jenkins CI"
                                git config --global user.email "jenkins@company.com"
                                
                                echo "=== Manifest Repository Clone ==="
                                rm -rf manifest-repo
                                git clone https://\$GIT_USERNAME:\$GIT_PASSWORD@github.com/won-ktds/smarketing-manifest.git manifest-repo
                                cd manifest-repo
                            """
                            
                            def fullImageName = "${props.registry}/${props.image_org}/smarketing-frontend:${imageTag}"
                            def deploymentFile = "smarketing-frontend/deployments/frontend-deployment.yaml"
                            
                            sh """
                                cd manifest-repo
                                
                                echo "=== smarketing-frontend ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ ==="
                                if [ -f "${deploymentFile}" ]; then
                                    # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ (sed ì‚¬ìš©)
                                    sed -i 's|image: ${props.registry}/${props.image_org}/smarketing-frontend:.*|image: ${fullImageName}|g' "${deploymentFile}"
                                    echo "Updated ${deploymentFile} with new image: ${fullImageName}"
                                    
                                    # ë³€ê²½ì‚¬í•­ í™•ì¸
                                    echo "=== ë³€ê²½ëœ ë‚´ìš© í™•ì¸ ==="
                                    grep "image: ${props.registry}/${props.image_org}/smarketing-frontend" "${deploymentFile}" || echo "ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ í™•ì¸ ì‹¤íŒ¨"
                                else
                                    echo "Warning: ${deploymentFile} not found"
                                    echo "Creating manifest directory structure..."
                                    
                                    # ê¸°ë³¸ êµ¬ì¡° ìƒì„±
                                    mkdir -p smarketing-frontend/deployments
                                    
                                    # ê¸°ë³¸ deployment íŒŒì¼ ìƒì„±
                                    cat > "${deploymentFile}" << EOF
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: smarketing-frontend-config
  namespace: ${props.namespace}
data:
  runtime-env.js: |
    window.__runtime_config__ = {
      AUTH_URL: '${props.auth_url}',
      MEMBER_URL: '${props.member_url}',
      STORE_URL: '${props.store_url}',
      MENU_URL: '${props.menu_url}',
      SALES_URL: '${props.sales_url}',
      CONTENT_URL: '${props.content_url}',
      RECOMMEND_URL: '${props.recommend_url}',
      GATEWAY_URL: 'http://${props.ingress_host}',
      ENV: 'production',
      DEBUG: false
    };

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: smarketing-frontend
  namespace: ${props.namespace}
  labels:
    app: smarketing-frontend
spec:
  replicas: ${props.replicas}
  selector:
    matchLabels:
      app: smarketing-frontend
  template:
    metadata:
      labels:
        app: smarketing-frontend
    spec:
      imagePullSecrets:
      - name: acr-secret
      containers:
      - name: smarketing-frontend
        image: ${fullImageName}
        imagePullPolicy: Always
        ports:
        - containerPort: ${props.export_port}
        resources:
          requests:
            cpu: ${props.resources_requests_cpu}
            memory: ${props.resources_requests_memory}
          limits:
            cpu: ${props.resources_limits_cpu}
            memory: ${props.resources_limits_memory}
        volumeMounts:
        - name: runtime-config
          mountPath: /usr/share/nginx/html/runtime-env.js
          subPath: runtime-env.js
        livenessProbe:
          httpGet:
            path: /health
            port: ${props.export_port}
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: ${props.export_port}
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: runtime-config
        configMap:
          name: smarketing-frontend-config

---
apiVersion: v1
kind: Service
metadata:
  name: smarketing-frontend-service
  namespace: ${props.namespace}
  labels:
    app: smarketing-frontend
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: ${props.export_port}
    protocol: TCP
    name: http
  selector:
    app: smarketing-frontend

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: smarketing-frontend-ingress
  namespace: ${props.namespace}
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  rules:
  - host: ${props.ingress_host}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: smarketing-frontend-service
            port:
              number: 80
EOF
                                    echo "Created basic frontend-deployment.yaml"
                                fi
                            """
                            
                            sh """
                                cd manifest-repo
                                
                                echo "=== Git ë³€ê²½ì‚¬í•­ í™•ì¸ ==="
                                git status
                                git diff
                                
                                # ë³€ê²½ì‚¬í•­ì´ ìžˆìœ¼ë©´ ì»¤ë°‹ ë° í‘¸ì‹œ
                                if [ -n "\$(git status --porcelain)" ]; then
                                    git add .
                                    git commit -m "Update smarketing-frontend to ${imageTag} - Build ${env.BUILD_NUMBER}"
                                    git push origin main
                                    echo "âœ… Successfully updated manifest repository"
                                else
                                    echo "â„¹ï¸ No changes to commit"
                                fi
                            """
                        }
                    }
                }
            }

            stage('Trigger ArgoCD Sync') {
                script {
                    echo """
ðŸŽ¯ Frontend CI Pipeline ì™„ë£Œ!

ðŸ“¦ ë¹Œë“œëœ ì´ë¯¸ì§€:
- ${props.registry}/${props.image_org}/smarketing-frontend:${imageTag}

ðŸ”„ ArgoCD ë™ìž‘:
- ArgoCDê°€ manifest repository ë³€ê²½ì‚¬í•­ì„ ìžë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤
- smarketing-frontend Applicationì´ ìƒˆë¡œìš´ ì´ë¯¸ì§€ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤
- ArgoCD UIì—ì„œ ë°°í¬ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”

ðŸŒ ArgoCD UI: [ArgoCD ì ‘ì† URL]
ðŸ“ Manifest Repo: ${MANIFEST_REPO}
                    """
                }
            }

            // ì„±ê³µ ì‹œ ì²˜ë¦¬
            echo """
âœ… Frontend CI Pipeline ì„±ê³µ!
ðŸ·ï¸ ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸: ${imageTag}
ðŸ”„ ArgoCDê°€ ìžë™ìœ¼ë¡œ ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤
            """

        } catch (Exception e) {
            // ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
            echo "âŒ Frontend CI Pipeline ì‹¤íŒ¨: ${e.getMessage()}"
            throw e
        } finally {
            // ì •ë¦¬ ìž‘ì—… (í•­ìƒ ì‹¤í–‰)
            container('podman') {
                sh 'podman system prune -f || true'
            }
            sh 'rm -rf manifest-repo || true'
        }
    }
}
