# Build stage
FROM node:20-slim AS builder

ARG PROJECT_FOLDER
ARG VUE_APP_AUTH_URL
ARG VUE_APP_MEMBER_URL
ARG VUE_APP_STORE_URL
ARG VUE_APP_MENU_URL
ARG VUE_APP_SALES_URL
ARG VUE_APP_CONTENT_URL
ARG VUE_APP_RECOMMEND_URL

ENV NODE_ENV=production
ENV VUE_APP_AUTH_URL=${VUE_APP_AUTH_URL}
ENV VUE_APP_MEMBER_URL=${VUE_APP_MEMBER_URL}
ENV VUE_APP_STORE_URL=${VUE_APP_STORE_URL}
ENV VUE_APP_MENU_URL=${VUE_APP_MENU_URL}
ENV VUE_APP_SALES_URL=${VUE_APP_SALES_URL}
ENV VUE_APP_CONTENT_URL=${VUE_APP_CONTENT_URL}
ENV VUE_APP_RECOMMEND_URL=${VUE_APP_RECOMMEND_URL}

WORKDIR /app

# Copy package files
COPY ${PROJECT_FOLDER}/package*.json ./

# Install all dependencies (including devDependencies for build)
RUN npm ci

# Copy source code
COPY ${PROJECT_FOLDER} .

# Build the application
RUN npm run build

# Production stage
FROM nginx:alpine AS production

ARG EXPORT_PORT=18080

# Copy built files from builder stage
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx configuration
COPY deployment/container/nginx.conf /etc/nginx/conf.d/default.conf

# Create nginx configuration with custom port
RUN sed -i "s/80/${EXPORT_PORT}/g" /etc/nginx/conf.d/default.conf

EXPOSE ${EXPORT_PORT}

CMD ["nginx", "-g", "daemon off;"]