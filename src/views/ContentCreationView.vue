<template>
  <v-container fluid class="pa-4">
    <v-row>
      <v-col cols="12">
        <v-card elevation="2">
          <v-card-title class="text-h6 pa-4">
            <v-icon class="mr-2" color="primary">mdi-pencil-plus</v-icon>
            AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
          </v-card-title>
          
          <v-divider />
          
          <v-card-text class="pa-4">
            <v-stepper
              v-model="currentStep"
              :items="stepperItems"
              alt-labels
            >
              <!-- Step 1: ÏΩòÌÖêÏ∏† ÌÉÄÏûÖ ÏÑ†ÌÉù -->
              <template v-slot:item.1>
                <v-card
                  class="pa-4"
                  flat
                >
                  <h3 class="text-h6 mb-4">Ïñ¥Îñ§ ÏΩòÌÖêÏ∏†Î•º ÎßåÎì§ÍπåÏöî?</h3>
                  
                  <v-row>
                    <v-col cols="12" md="6">
                      <v-card
                        :class="['content-type-card', { 'selected': contentData.type === 'SNS_POST' }]"
                        @click="contentData.type = 'SNS_POST'"
                        hover
                      >
                        <v-card-text class="text-center pa-6">
                          <v-icon size="48" color="pink" class="mb-3">mdi-instagram</v-icon>
                          <h4 class="text-h6 mb-2">SNS Í≤åÏãúÎ¨º</h4>
                          <p class="text-body-2">Ïù∏Ïä§ÌÉÄÍ∑∏Îû® & Î∏îÎ°úÍ∑∏Ïö© Í≤åÏãúÎ¨º</p>
                        </v-card-text>
                      </v-card>
                    </v-col>
                    
                    <v-col cols="12" md="6">
                      <v-card
                        :class="['content-type-card', { 'selected': contentData.type === 'POSTER' }]"
                        @click="contentData.type = 'POSTER'"
                        hover
                      >
                        <v-card-text class="text-center pa-6">
                          <v-icon size="48" color="purple" class="mb-3">mdi-image</v-icon>
                          <h4 class="text-h6 mb-2">ÌôçÎ≥¥ Ìè¨Ïä§ÌÑ∞</h4>
                          <p class="text-body-2">Îß§Ïû• Í≤åÏãúÏö© Ìè¨Ïä§ÌÑ∞</p>
                        </v-card-text>
                      </v-card>
                    </v-col>
                  </v-row>
                </v-card>
              </template>

              <!-- Step 2: ÌôçÎ≥¥ ÎåÄÏÉÅ ÏÑ†ÌÉù -->
              <template v-slot:item.2>
                <v-card class="pa-4" flat>
                  <h3 class="text-h6 mb-4">Î¨¥ÏóáÏùÑ ÌôçÎ≥¥Ìï†ÍπåÏöî?</h3>
                  
                  <v-radio-group v-model="contentData.target">
                    <v-radio
                      label="üçú Î©îÎâ¥ ÌôçÎ≥¥"
                      value="menu"
                    />
                    <v-radio
                      label="üè™ Îß§Ïû• ÏÜåÍ∞ú"
                      value="store"
                    />
                    <v-radio
                      label="üéâ Ïù¥Î≤§Ìä∏ ÌôçÎ≥¥"
                      value="event"
                    />
                  </v-radio-group>
                  
                  <!-- Î©îÎâ¥ ÏÑ†ÌÉù -->
                  <v-select
                    v-if="contentData.target === 'menu'"
                    v-model="contentData.selectedMenu"
                    label="ÌôçÎ≥¥Ìï† Î©îÎâ¥ ÏÑ†ÌÉù"
                    variant="outlined"
                    :items="menuOptions"
                    item-title="text"
                    item-value="value"
                    class="mt-4"
                  />
                  
                  <!-- Ïù¥Î≤§Ìä∏ ÏûÖÎ†• -->
                  <v-text-field
                    v-if="contentData.target === 'event'"
                    v-model="contentData.eventName"
                    label="Ïù¥Î≤§Ìä∏Î™Ö"
                    variant="outlined"
                    placeholder="Ïòà: Ïã†Î©îÎâ¥ Ï∂úÏãú Ïù¥Î≤§Ìä∏"
                    class="mt-4"
                  />
                </v-card>
              </template>

              <!-- Step 3: Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú -->
              <template v-slot:item.3>
                <v-card class="pa-4" flat>
                  <h3 class="text-h6 mb-4">Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</h3>
                  
                  <v-file-input
                    v-model="contentData.images"
                    label="Ïù¥ÎØ∏ÏßÄ ÌååÏùº"
                    variant="outlined"
                    accept="image/*"
                    multiple
                    prepend-icon="mdi-camera"
                    show-size
                    chips
                    class="mb-4"
                  />
                  
                  <!-- Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                  <v-row v-if="imagePreviewUrls.length > 0">
                    <v-col
                      v-for="(url, index) in imagePreviewUrls"
                      :key="index"
                      cols="6"
                      md="3"
                    >
                      <v-card class="pa-2">
                        <v-img
                          :src="url"
                          height="100"
                          cover
                        />
                      </v-card>
                    </v-col>
                  </v-row>
                </v-card>
              </template>

              <!-- Step 4: ÏÑ∏Î∂Ä ÏòµÏÖò -->
              <template v-slot:item.4>
                <v-card class="pa-4" flat>
                  <h3 class="text-h6 mb-4">ÏÑ∏Î∂Ä ÏòµÏÖòÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî</h3>
                  
                  <v-row>
                    <v-col cols="12" md="6">
                      <v-select
                        v-model="contentData.toneAndManner"
                        label="ÌÜ§Ïï§Îß§ÎÑà"
                        variant="outlined"
                        :items="TONE_OPTIONS"
                        item-title="text"
                        item-value="value"
                      />
                    </v-col>
                    
                    <v-col cols="12" md="6">
                      <v-select
                        v-model="contentData.emotionIntensity"
                        label="Í∞êÏ†ï Í∞ïÎèÑ"
                        variant="outlined"
                        :items="EMOTION_INTENSITY"
                        item-title="text"
                        item-value="value"
                      />
                    </v-col>
                    
                    <v-col cols="12" md="6">
                      <v-select
                        v-model="contentData.promotion"
                        label="ÌîÑÎ°úÎ™®ÏÖò Ï†ïÎ≥¥"
                        variant="outlined"
                        :items="PROMOTION_OPTIONS"
                        item-title="text"
                        item-value="value"
                      />
                    </v-col>
                    
                    <!-- SNS ÌîåÎû´Ìèº ÏÑ†ÌÉù (SNS Í≤åÏãúÎ¨ºÏù∏ Í≤ΩÏö∞Îßå) -->
                    <v-col
                      v-if="contentData.type === 'SNS_POST'"
                      cols="12" md="6"
                    >
                      <v-select
                        v-model="contentData.platform"
                        label="Í≤åÏãú ÌîåÎû´Ìèº"
                        variant="outlined"
                        :items="platformOptions"
                        item-title="text"
                        item-value="value"
                      />
                    </v-col>
                  </v-row>
                  
                  <!-- Í∏∞Í∞Ñ ÏÑ§Ï†ï -->
                  <v-row>
                    <v-col cols="12" md="6">
                      <v-text-field
                        v-model="contentData.startDate"
                        label="ÌôçÎ≥¥ ÏãúÏûëÏùº"
                        variant="outlined"
                        type="date"
                      />
                    </v-col>
                    <v-col cols="12" md="6">
                      <v-text-field
                        v-model="contentData.endDate"
                        label="ÌôçÎ≥¥ Ï¢ÖÎ£åÏùº"
                        variant="outlined"
                        type="date"
                      />
                    </v-col>
                  </v-row>
                </v-card>
              </template>

              <!-- Step 5: ÏÉùÏÑ± Í≤∞Í≥º -->
              <template v-slot:item.5>
                <v-card class="pa-4" flat>
                  <h3 class="text-h6 mb-4">ÏÉùÏÑ±Îêú ÏΩòÌÖêÏ∏†</h3>
                  
                  <v-card
                    v-if="generatedContent"
                    class="pa-4 mb-4"
                    color="blue-grey-lighten-5"
                    variant="tonal"
                  >
                    <h4 class="text-h6 mb-2">{{ generatedContent.title }}</h4>
                    <div class="text-body-1 mb-3" style="white-space: pre-line;">
                      {{ generatedContent.content }}
                    </div>
                    
                    <!-- Ìï¥ÏãúÌÉúÍ∑∏ (SNSÏù∏ Í≤ΩÏö∞) -->
                    <div
                      v-if="generatedContent.hashtags && generatedContent.hashtags.length > 0"
                      class="mb-3"
                    >
                      <v-chip
                        v-for="tag in generatedContent.hashtags"
                        :key="tag"
                        class="mr-1 mb-1"
                        size="small"
                        color="primary"
                      >
                        {{ tag }}
                      </v-chip>
                    </div>
                  </v-card>
                  
                  <!-- Î°úÎî© ÏÉÅÌÉú -->
                  <v-card
                    v-else-if="generating"
                    class="pa-8 text-center"
                  >
                    <v-progress-circular
                      indeterminate
                      color="primary"
                      size="64"
                      class="mb-4"
                    />
                    <p class="text-body-1">AIÍ∞Ä ÏΩòÌÖêÏ∏†Î•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                    <p class="text-body-2 grey--text">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</p>
                  </v-card>
                  
                  <!-- ÏÉùÏÑ± Ïã§Ìå® -->
                  <v-card
                    v-else-if="generationError"
                    class="pa-6 text-center"
                    color="error"
                    variant="tonal"
                  >
                    <v-icon size="48" color="error" class="mb-2">mdi-alert-circle</v-icon>
                    <p class="text-body-1">ÏΩòÌÖêÏ∏† ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§</p>
                    <p class="text-body-2">{{ generationError }}</p>
                  </v-card>
                </v-card>
              </template>
            </v-stepper>
          </v-card-text>
          
          <v-divider />
          
          <!-- Ïï°ÏÖò Î≤ÑÌäº -->
          <v-card-actions class="pa-4">
            <v-btn
              v-if="currentStep > 1"
              color="grey"
              variant="outlined"
              @click="currentStep--"
            >
              Ïù¥Ï†Ñ
            </v-btn>
            
            <v-spacer />
            
            <!-- Îã§Ïùå/ÏÉùÏÑ± Î≤ÑÌäº -->
            <v-btn
              v-if="currentStep < 5"
              color="primary"
              :disabled="!canProceed"
              @click="nextStep"
            >
              {{ currentStep === 4 ? 'AI ÏÉùÏÑ±ÌïòÍ∏∞' : 'Îã§Ïùå' }}
            </v-btn>
            
            <!-- Ï†ÄÏû• Î≤ÑÌäº -->
            <v-btn
              v-if="currentStep === 5 && generatedContent"
              color="success"
              :loading="saving"
              @click="saveContent"
            >
              Ï†ÄÏû•ÌïòÍ∏∞
            </v-btn>
            
            <!-- Ïû¨ÏÉùÏÑ± Î≤ÑÌäº -->
            <v-btn
              v-if="currentStep === 5"
              color="primary"
              variant="outlined"
              :loading="generating"
              @click="regenerateContent"
            >
              Îã§Ïãú ÏÉùÏÑ±
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-col>
    </v-row>
    
    <!-- ÏÑ±Í≥µ Ïä§ÎÇµÎ∞î -->
    <v-snackbar
      v-model="showSuccess"
      color="success"
      timeout="3000"
    >
      ÏΩòÌÖêÏ∏†Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!
    </v-snackbar>
    
    <!-- ÏóêÎü¨ Ïä§ÎÇµÎ∞î -->
    <v-snackbar
      v-model="showError"
      color="error"
      timeout="3000"
    >
      {{ errorMessage }}
    </v-snackbar>
  </v-container>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useContentStore } from '@/store/content'
import { useStoreStore } from '@/store/store'
import { TONE_OPTIONS, EMOTION_INTENSITY, PROMOTION_OPTIONS, PLATFORMS } from '@/utils/constants'

const router = useRouter()
const contentStore = useContentStore()
const storeStore = useStoreStore()

// Ïä§ÌÖåÌçº ÏÑ§Ï†ï
const currentStep = ref(1)
const stepperItems = [
  { title: 'ÌÉÄÏûÖ ÏÑ†ÌÉù', value: 1 },
  { title: 'ÌôçÎ≥¥ ÎåÄÏÉÅ', value: 2 },
  { title: 'Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú', value: 3 },
  { title: 'ÏÑ∏Î∂Ä ÏòµÏÖò', value: 4 },
  { title: 'ÏÉùÏÑ± ÏôÑÎ£å', value: 5 }
]

// ÏΩòÌÖêÏ∏† Îç∞Ïù¥ÌÑ∞
const contentData = ref({
  type: '',
  target: '',
  selectedMenu: null,
  eventName: '',
  images: [],
  toneAndManner: 'ÏπúÍ∑ºÌï®',
  emotionIntensity: 'Î≥¥ÌÜµ',
  promotion: 'ÏóÜÏùå',
  platform: 'INSTAGRAM',
  startDate: '',
  endDate: ''
})

// ÏÉÅÌÉú Í¥ÄÎ¶¨
const generating = ref(false)
const saving = ref(false)
const generatedContent = ref(null)
const generationError = ref('')
const showSuccess = ref(false)
const showError = ref(false)
const errorMessage = ref('')

// Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞
const imagePreviewUrls = ref([])

// Í≥ÑÏÇ∞Îêú ÏÜçÏÑ±
const canProceed = computed(() => {
  switch (currentStep.value) {
    case 1:
      return !!contentData.value.type
    case 2:
      if (contentData.value.target === 'menu') {
        return !!contentData.value.selectedMenu
      } else if (contentData.value.target === 'event') {
        return !!contentData.value.eventName
      }
      return !!contentData.value.target
    case 3:
      return contentData.value.images.length > 0
    case 4:
      return true
    default:
      return false
  }
})

const menuOptions = computed(() => {
  return storeStore.menus.map(menu => ({
    text: menu.menuName,
    value: menu.id
  }))
})

const platformOptions = [
  { text: 'Ïù∏Ïä§ÌÉÄÍ∑∏Îû®', value: 'INSTAGRAM' },
  { text: 'ÎÑ§Ïù¥Î≤Ñ Î∏îÎ°úÍ∑∏', value: 'NAVER_BLOG' }
]

/**
 * Îã§Ïùå Îã®Í≥ÑÎ°ú Ïù¥Îèô
 */
const nextStep = async () => {
  if (currentStep.value === 4) {
    await generateContent()
  } else {
    currentStep.value++
  }
}

/**
 * ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
 */
const generateContent = async () => {
  generating.value = true
  generationError.value = ''
  currentStep.value = 5
  
  try {
    let response
    
    if (contentData.value.type === 'SNS_POST') {
      response = await contentStore.generateSNSContent({
        target: contentData.value.target,
        selectedMenu: contentData.value.selectedMenu,
        eventName: contentData.value.eventName,
        images: contentData.value.images,
        toneAndManner: contentData.value.toneAndManner,
        emotionIntensity: contentData.value.emotionIntensity,
        promotion: contentData.value.promotion,
        platform: contentData.value.platform,
        startDate: contentData.value.startDate,
        endDate: contentData.value.endDate
      })
    } else {
      response = await contentStore.generatePosterContent({
        target: contentData.value.target,
        selectedMenu: contentData.value.selectedMenu,
        eventName: contentData.value.eventName,
        images: contentData.value.images,
        toneAndManner: contentData.value.toneAndManner,
        promotion: contentData.value.promotion,
        startDate: contentData.value.startDate,
        endDate: contentData.value.endDate
      })
    }
    
    generatedContent.value = response
  } catch (error) {
    console.error('ÏΩòÌÖêÏ∏† ÏÉùÏÑ± Ïã§Ìå®:', error)
    generationError.value = 'ÏΩòÌÖêÏ∏† ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
    
    // ÏÉòÌîå Îç∞Ïù¥ÌÑ∞Î°ú ÎåÄÏ≤¥
    generatedContent.value = {
      title: 'Ïã†Î©îÎâ¥ Îñ°Î≥∂Ïù¥ Ï∂úÏãú!',
      content: `üî• ÏÉàÎ°úÏö¥ ÎßõÏùò Îñ°Î≥∂Ïù¥Í∞Ä Ï∂úÏãúÎêòÏóàÏñ¥Ïöî! üî•

Îß§ÏΩ§Îã¨ÏΩ§Ìïú ÌäπÏ†ú ÏÜåÏä§Î°ú ÎßåÎì† Ïö∞Î¶¨ Îß§Ïû•ÎßåÏùò ÏãúÍ∑∏ÎãàÏ≤ò Îñ°Î≥∂Ïù¥Î•º ÎßõÎ≥¥ÏÑ∏Ïöî!

Ïã†ÏÑ†Ìïú Îñ°Í≥º Ï†ïÏÑ±Ïä§ÎüΩÍ≤å ÎÅìÏù∏ Íµ≠Î¨ºÏùò Ï°∞ÌôîÍ∞Ä ÏùºÌíàÏûÖÎãàÎã§.

ÏßÄÍ∏à Î∞©Î¨∏ÌïòÏãúÎ©¥ ÌäπÎ≥Ñ Ìï†Ïù∏Í∞ÄÎ°ú ÎßåÎÇòÎ≥¥Ïã§ Ïàò ÏûàÏñ¥Ïöî! ‚ú®`,
      hashtags: ['#Îñ°Î≥∂Ïù¥', '#Ïã†Î©îÎâ¥', '#Î∂ÑÏãùÎßõÏßë', '#ÍπÄÏÇ¨Ïû•ÎãòÎ∂ÑÏãùÏ†ê', '#Îß§Ïö¥Îßõ', '#Îã¨ÏΩ§ÌïúÎßõ']
    }
  } finally {
    generating.value = false
  }
}

/**
 * ÏΩòÌÖêÏ∏† Ïû¨ÏÉùÏÑ±
 */
const regenerateContent = async () => {
  generatedContent.value = null
  await generateContent()
}

/**
 * ÏΩòÌÖêÏ∏† Ï†ÄÏû•
 */
const saveContent = async () => {
  saving.value = true
  try {
    const saveData = {
      ...contentData.value,
      ...generatedContent.value
    }
    
    if (contentData.value.type === 'SNS_POST') {
      await contentStore.saveSNSContent(saveData)
    } else {
      await contentStore.savePosterContent(saveData)
    }
    
    showSuccess.value = true
    
    // Ïû†Ïãú ÌõÑ ÏΩòÌÖêÏ∏† Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
    setTimeout(() => {
      router.push({ name: 'ContentManagement' })
    }, 2000)
  } catch (error) {
    console.error('ÏΩòÌÖêÏ∏† Ï†ÄÏû• Ïã§Ìå®:', error)
    errorMessage.value = 'ÏΩòÌÖêÏ∏† Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.'
    showError.value = true
  } finally {
    saving.value = false
  }
}

// Ïù¥ÎØ∏ÏßÄ ÌååÏùº Î≥ÄÍ≤Ω Í∞êÏßÄ
watch(() => contentData.value.images, (newImages) => {
  imagePreviewUrls.value = []
  
  if (newImages && newImages.length > 0) {
    newImages.forEach(file => {
      const reader = new FileReader()
      reader.onload = (e) => {
        imagePreviewUrls.value.push(e.target.result)
      }
      reader.readAsDataURL(file)
    })
  }
})

// Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
onMounted(async () => {
  try {
    await storeStore.fetchMenus()
  } catch (error) {
    console.error('Î©îÎâ¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error)
  }
  
  // Í∏∞Î≥∏ ÎÇ†Ïßú ÏÑ§Ï†ï
  const today = new Date().toISOString().split('T')[0]
  const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  
  contentData.value.startDate = today
  contentData.value.endDate = nextWeek
})
</script>

<style scoped>
.content-type-card {
  transition: all 0.3s;
  cursor: pointer;
  border: 2px solid transparent;
}

.content-type-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.content-type-card.selected {
  border-color: #1976D2;
  background-color: #E3F2FD;
}
</style>